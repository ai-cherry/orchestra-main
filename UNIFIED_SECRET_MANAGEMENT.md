# Unified Secret Management System for GCP Environments

## Project Overview

This project provides a comprehensive secret management solution that:

1. **Migrates GitHub Secrets to GCP Secret Manager** with a robust migration tool and GitHub Actions workflow
2. **Implements zero-trust access with IAM Conditions** including time-based and service-based restrictions
3. **Integrates with Docker builds and DevContainers** for seamless development workflow
4. **Provides automated rotation via Cloud Scheduler** with customizable rotation strategies

## Directory Structure

```
secret-management/
├── terraform/
│   ├── modules/
│   │   ├── secret-manager/       # Core Secret Manager module
│   │   └── secret-rotation/      # Automated rotation module
│   │       └── function/         # Secret rotation Cloud Function
│   └── deployment/               # Generated by deploy script
├── python/
│   └── gcp_secret_client/        # Python client library
├── examples/
│   └── docker-build-integration/ # Docker integration utilities
├── migrate_github_to_gcp.py      # GitHub migration script
├── deploy_secret_manager.sh      # Deployment script
└── README.md                     # Documentation
```

## Key Components

### 1. Secret Manager Terraform Module

The Secret Manager module (`secret-management/terraform/modules/secret-manager/`) provides:

- Creation and management of GCP Secret Manager secrets
- IAM bindings with conditional access controls
- Support for versioning and replication
- Organization with labels and metadata

```hcl
module "secret_manager" {
  source     = "../modules/secret-manager"
  project_id = "your-project-id"

  secrets = {
    "api-key" = {
      labels = { type = "api" }
      access = {
        "roles/secretmanager.secretAccessor" = {
          members = ["serviceAccount:app@project.iam.gserviceaccount.com"]
          condition = {
            title       = "business_hours_only"
            description = "Only allow access during business hours"
            expression  = "request.time.getHours('America/New_York') >= 9 && request.time.getHours('America/New_York') < 17"
          }
        }
      }
    }
  }
}
```

### 2. Secret Rotation Module

The rotation module (`secret-management/terraform/modules/secret-rotation/`) provides:

- Cloud Scheduler job to trigger rotations on a schedule
- Cloud Function to execute the rotation logic
- Support for multiple rotation strategies
- Proper IAM permissions and security controls

```hcl
module "secret_rotation" {
  source           = "../modules/secret-rotation"
  project_id       = "your-project-id"
  environment      = "prod"
  secrets_to_rotate = ["api-key", "db-password"]
  rotation_schedule = "0 0 1 * *"  # First of every month
}
```

### 3. Python Client Library

The Python client (`secret-management/python/gcp_secret_client/`) provides:

- Robust error handling and retries
- Caching with TTL for performance
- Fallback to environment variables
- Support for JSON parsing and transformations

```python
from gcp_secret_client import SecretClient

client = SecretClient(project_id="your-project")
db_config = client.get_json_secret("DATABASE_CONFIG")
```

### 4. GitHub Migration Tool

The migration script (`secret-management/migrate_github_to_gcp.py`) provides:

- Automated migration from GitHub Secrets to GCP
- Support for IAM conditions and access controls
- Validation and reporting
- GitHub Actions workflow integration

```bash
python migrate_github_to_gcp.py --project-id=your-project --repo=owner/repo \
  --service-accounts=app@project.iam.gserviceaccount.com --time-condition
```

### 5. Docker Integration

The Docker integration (`secret-management/examples/docker-build-integration/`) provides:

- Generation of build arguments for Docker builds
- Environment file generation for docker-compose
- DevContainer configuration updates

```bash
# Generate Docker build args
python docker_secrets.py build-args --project-id=your-project \
  --secrets=DB_PASSWORD,API_KEY
```

## Deployment

The deployment script (`secret-management/deploy_secret_manager.sh`) provides:

- Single-command deployment of all components
- Configuration options for customization
- Support for multiple environments
- GitHub secret migration option

```bash
./deploy_secret_manager.sh --project-id=your-project --environment=prod \
  --migrate-github --github-repo=owner/repo --time-condition
```

## Zero-Trust Security Features

1. **Time-Based Conditions**: Limit access to specific time windows

   ```
   "request.time.getHours('America/New_York') >= 9 && request.time.getHours('America/New_York') < 17"
   ```

2. **Service-Based Restrictions**: Limit access to specific services

   ```
   "resource.service.name == 'cloudrun.googleapis.com'"
   ```

3. **IP-Based Restrictions**: Limit access to specific networks

   ```
   "request.ip.matches('10.0.0.0/8')"
   ```

4. **Regular Rotation**: Automated rotation of secrets on a schedule

5. **Minimal Access**: Fine-grained IAM permissions for each secret

## Getting Started

1. Clone the repository
2. Run the deployment script with your GCP project ID
3. Configure secrets in the generated Terraform configuration
4. Apply the Terraform configuration
5. Update your applications to use the Python client library

## Next Steps and Customization

1. **Custom Rotation Strategies**: Add custom logic to the rotation function
2. **Additional IAM Conditions**: Implement more complex access conditions
3. **Integration with CI/CD**: Configure GitHub Actions for deployment
4. **Monitoring and Alerting**: Add CloudWatch alerts for rotation failures

---

This unified secret management system provides a comprehensive solution for securing sensitive information in GCP environments while maintaining developer productivity through seamless integrations.
