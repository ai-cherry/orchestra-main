# MCP Server Management Guide

## Overview

The Model Context Protocol (MCP) servers provide specialized tools and capabilities to Claude Code within the Cursor IDE. This guide covers setup, management, and troubleshooting of MCP servers.

## Quick Start

### Setup Claude Code with MCP
```bash
./scripts/setup_claude_code.sh
```

### Launch Cursor with MCP Servers
```bash
./launch_cursor_with_claude.sh
```

### Check Server Status
```bash
./check_mcp_servers.sh
```

## Server Management

### Using the Management Script

The `manage_mcp_servers.sh` script provides comprehensive server control:

```bash
# List available servers
./manage_mcp_servers.sh list

# Start all servers
./manage_mcp_servers.sh start

# Start specific server
./manage_mcp_servers.sh start dragonfly

# Check status
./manage_mcp_servers.sh status

# Stop servers
./manage_mcp_servers.sh stop gcp-secrets

# Restart servers
./manage_mcp_servers.sh restart
```

### Available Servers

1. **gcp-cloud-run** - Deploy and manage Cloud Run services
   - Required: `GCP_PROJECT_ID`, `GCP_REGION`
   - Capabilities: deploy, update, status, list, logs, scale

2. **gcp-secrets** - Manage Google Secret Manager
   - Required: `GCP_PROJECT_ID`
   - Capabilities: get, create, update, list, versions

3. **dragonfly** - Short-term memory cache (DragonflyDB)
   - Optional: `DRAGONFLY_HOST`, `DRAGONFLY_PORT`, `DRAGONFLY_PASSWORD`
   - Capabilities: get, set, delete, list, ttl, pipeline

4. **firestore** - Mid-term episodic memory (Firestore)
   - Required: `GCP_PROJECT_ID`
   - Capabilities: create, read, update, query, batch, transaction

## Logging and Debugging

### Log Locations

- Setup logs: `~/.claude-code/logs/setup_*.log`
- Server logs: `~/.claude-code/logs/mcp_<server>_<date>.log`
- Launch logs: `~/.claude-code/logs/cursor_launch_*.log`

### Viewing Logs

```bash
# View latest setup log
tail -f ~/.claude-code/logs/setup_*.log

# View specific server log
tail -f ~/.claude-code/logs/mcp_dragonfly_*.log

# Check for errors
grep ERROR ~/.claude-code/logs/*.log
```

### Common Issues and Solutions

1. **Server won't start**
   - Check if required environment variables are set
   - Verify Python dependencies are installed
   - Check log files for specific errors

2. **Server crashes immediately**
   - Run syntax check: `python -m py_compile <server_file>`
   - Check for missing imports or dependencies
   - Verify GCP credentials if using GCP services

3. **Connection refused**
   - Ensure backend services are running (DragonflyDB, etc.)
   - Check firewall/network settings
   - Verify connection parameters in environment

## Server Registry

The server registry (`mcp_server/server_registry.json`) defines available servers and their requirements:

```json
{
  "version": "1.0.0",
  "servers": {
    "server-name": {
      "path": "servers/server_file.py",
      "command": "python",
      "description": "Server description",
      "required_env": ["ENV_VAR1", "ENV_VAR2"],
      "optional_env": ["OPT_VAR1"]
    }
  }
}
```

## Creating New Servers

Use the template at `mcp_server/servers/example_server.py.template` as a starting point:

1. Copy the template:
   ```bash
   cp mcp_server/servers/example_server.py.template mcp_server/servers/my_server.py
   ```

2. Implement your server logic

3. Add to server registry

4. Test the server:
   ```bash
   python mcp_server/servers/my_server.py
   ```

5. Add to management scripts

## Environment Setup

### Required Environment Variables

Set these in `~/.gcp_env_setup.sh`:

```bash
export GCP_PROJECT_ID="your-project-id"
export GCP_REGION="us-central1"
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/credentials.json"

# Optional for DragonflyDB
export DRAGONFLY_HOST="localhost"
export DRAGONFLY_PORT="6379"
export DRAGONFLY_PASSWORD="your-password"
```

### Loading Environment

The scripts automatically source `~/.gcp_env_setup.sh` if it exists.

## Integration with Claude Code

### Using MCP Tools in Claude

Once servers are running, you can use their tools in Claude Code:

```
# Deploy to Cloud Run
"Deploy my FastAPI app to Cloud Run staging environment"

# Secret Management
"Get the database password from Secret Manager"

# Caching
"Cache this user profile in DragonflyDB with key user:123"

# Firestore Operations
"Store this conversation in Firestore under conversations collection"
```

### MCP Configuration

The Claude Code configuration is stored at `~/.config/claude/config.json` and is automatically generated by the setup script.

## Monitoring and Health Checks

### Server Health

The launch script includes automatic monitoring:
- Checks if servers are still running every 5 seconds
- Attempts to restart crashed servers
- Logs all events for debugging

### Manual Health Check

```bash
# Check if server process is running
ps aux | grep mcp_server

# Check specific server PID
cat ~/.claude-code/pids/mcp_dragonfly.pid
kill -0 $(cat ~/.claude-code/pids/mcp_dragonfly.pid)
```

## Best Practices

1. **Always check logs** when servers fail to start
2. **Set up environment variables** before running servers
3. **Use the management script** for consistent server control
4. **Monitor resource usage** - MCP servers can consume memory
5. **Restart servers** if they become unresponsive
6. **Keep servers updated** with the latest fixes

## Troubleshooting Commands

```bash
# Check Python version
python --version

# Verify imports
python -c "import mcp_server"

# Test GCP authentication
gcloud auth list

# Check if ports are in use
netstat -tuln | grep 6379

# Clear PID files if needed
rm ~/.claude-code/pids/*.pid

# Full system check
./check_mcp_servers.sh && ./manage_mcp_servers.sh status
```

## Support

For issues:
1. Check the logs first
2. Verify environment setup
3. Consult server-specific documentation
4. Check the example server template for patterns