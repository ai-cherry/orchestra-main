# Figma Webhook Integration

This document provides comprehensive information about the Figma webhook integration setup that synchronizes design changes from Figma to our codebase via GitHub Actions.

## Overview

The integration automatically updates our design assets when changes are made to the design system in Figma. This is achieved through a webhook that triggers a GitHub Actions workflow, which then:

1. Pulls the latest design tokens from Figma
2. Converts them to platform-specific formats (CSS, JS, Android, iOS)
3. Updates our Terraform configuration
4. Validates the design tokens using Vertex AI
5. Deploys the changes with a canary release strategy

## Requirements

### Figma Requirements

- **Figma File ID**: `368236963`
- **Figma Team ID**: From your Figma organization settings
- **Figma Personal Access Token (PAT)** with scopes:
  - `files:read`
  - `variables:write`
  - `code_connect:write`

### GitHub Requirements

- GitHub repository with Actions enabled
- GitHub Personal Access Token with `repo` scope
- Repository secrets:
  - `FIGMA_PAT`: Figma Personal Access Token
  - `FIGMA_WEBHOOK_SECRET`: Secret for webhook validation
  - `GCP_SA_KEY_JSON`: GCP Service Account key for Secret Manager and Vertex AI access
  - `GCP_PROJECT_ID`: Google Cloud Project ID
  - `REDIS_PASSWORD`: Redis password for caching

### GCP Requirements

- Service account with roles:
  - `roles/secretmanager.secretAccessor`
  - `roles/aiplatform.user`
  - `roles/redis.editor`
- Vertex AI Workbench instance (n1-standard-4)
- Firestore NATIVE with backup policies
- Memorystore Redis (3GB)

## Setup Instructions

### 1. Validate Figma PAT Scopes

Before setting up the webhook, verify that your Figma PAT has the required scopes:

```bash
# Environment variable must be set
export FIGMA_PAT=your_figma_pat

# Run the validation script
python scripts/validate_figma_pat.py
```

### 2. Create the Figma Webhook

Use the provided script to set up the Figma webhook:

```bash
# Make the script executable
chmod +x scripts/setup_figma_webhook.sh

# Run the script with required parameters
./scripts/setup_figma_webhook.sh \
  --file-key 368236963 \
  --team-id YOUR_TEAM_ID \
  --github-repo your-org/your-repo \
  --github-token YOUR_GITHUB_TOKEN
```

The script will:
- Create a webhook in Figma
- Generate a webhook secret
- Save webhook details to `figma_webhook_details.json`
- Provide instructions for setting up GitHub secrets

### 3. Configure GitHub Secrets

Follow the instructions provided by the script to add the webhook secret to your GitHub repository. You'll need to add:

- `FIGMA_WEBHOOK_SECRET`: The secret generated by the script
- Other required secrets as listed in the requirements section

### 4. Verify Component Mapping

After setting up the webhook, verify that our component definitions match their implementations:

```bash
python scripts/improve_component_mapping.py
```

This will analyze the mappings between components defined in `component-adaptation-mapping.json` and their implementations in:
- `packages/ui/src/tokens/variables.js`
- `packages/ui/android/src/main/res/values/styles.xml`

### 5. Verify Cline MCP Tools

Ensure all required Cline MCP tools are installed and at the correct versions:

```bash
python scripts/verify_cline_tools.py
```

This checks for:
- figma-sync (v1.3.0+)
- terraform-linter (v2.8+)
- gcp-cost (v0.9+)

## Workflow Details

### GitHub Actions Workflow

The webhook triggers the `.github/workflows/figma-gcp-sync.yml` workflow which performs:

1. **Validation**: Validates the Figma PAT scopes and webhook signature
2. **Synchronization**: Runs `figma_gcp_sync.py` to fetch design variables
3. **Verification**: Validates design tokens with Vertex AI
4. **Deployment**: Deploys updates to Cloud Run with a 10% canary strategy

### Design Token Generation

The `figma_gcp_sync.py` script:
- Fetches design variables from Figma
- Generates platform-specific implementation files:
  - CSS variables
  - JavaScript module
  - Android XML resources
  - iOS Swift files
  - Terraform variables
- Updates Secret Manager with the latest tokens

### Error Handling

The workflow includes error handling for:
- Figma API failures
- Validation errors in design tokens
- Deployment issues

If validation fails, the workflow will not proceed to deployment, and notifications will be sent to the team.

## Troubleshooting

### Common Issues

#### Webhook Failure

If the webhook fails to trigger:

1. Check the webhook status in Figma (Team Settings > Dev > Webhooks)
2. Verify the webhook secret in GitHub secrets
3. Ensure the Figma PAT has not expired
4. Check the GitHub repository dispatch endpoint is accessible

#### GCP Permissions

If GCP operations fail:

1. Verify the service account has the required roles
2. Check that Vertex AI API is enabled
3. Ensure the service account key is correctly stored in GitHub secrets

#### Design Token Validation Errors

If design token validation fails:

1. Check Figma file for inconsistent naming patterns
2. Look for duplicate color definitions
3. Verify color contrast meets accessibility standards
4. Ensure all required tokens are defined

## Maintenance

### Rotating Secrets

It's recommended to rotate the Figma PAT and webhook secret periodically:

1. Generate a new Figma PAT
2. Update the `FIGMA_PAT` secret in GitHub
3. Run `setup_figma_webhook.sh` with the `--secret` option to generate a new webhook secret
4. Update the `FIGMA_WEBHOOK_SECRET` in GitHub

### Monitoring

Monitor the webhook health:
- Check GitHub Actions workflow runs
- Review Figma webhook logs in Team settings
- Monitor GCP logs for sync operations

## References

- [Figma API Documentation](https://www.figma.com/developers/api)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GCP Secret Manager Documentation](https://cloud.google.com/secret-manager/docs)
- [Vertex AI Documentation](https://cloud.google.com/vertex-ai/docs)

## Support

If you encounter issues with this integration, please contact the design system team at design-system@example.com.
