name: AI-Enhanced Deployment
on: [push]

jobs:
  deploy:
    runs-on: vertex-ai
    strategy:
      matrix:
        python: ["3.11"]
        region: ["us-central1"]
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install poetry
        poetry install

    - name: Run Critical Tests
      run: |
        export PYTHONPATH=$(pwd)
        poetry run pytest tests/ -m critical -v
        if [ $? -ne 0 ]; then
          echo "Critical tests failed. Halting deployment."
          exit 1
        fi
    
    - name: Auth GCP
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: projects/525398941159/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: github-actions-deployer@cherry-ai-project.iam.gserviceaccount.com
        
    - name: Gemini Code Review
      run: |
        # Use Gemini for security analysis
        gcloud alpha ai code-assist review \
          --source=. \
          --category=security \
          --project=cherry-ai-project

    - name: Deploy with Vertex AI
      run: |
        gcloud ai endpoints deploy-model orchestra-prod \
          --project=cherry-ai-project \
          --model=gemini-pro \
          --machine-type=a2-highgpu-1g \
          --accelerator=type=nvidia-tesla-a100,count=1
