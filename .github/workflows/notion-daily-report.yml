name: 🍒 Daily Notion Report

on:
  schedule:
    # Run daily at 9 AM UTC (adjust for your timezone)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  daily-notion-report:
    name: Generate Daily Notion Report
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install Python Dependencies
        run: |
          pip install requests

      - name: 📊 Generate System Health Report
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          cd .patrick
          
          # Test Notion connectivity
          python3 notion-integration.py --daily-status
          
          # Generate mockup report
          python3 notion-integration.py --mockup-report

      - name: 📈 Collect System Metrics
        run: |
          echo "## 🍒 Daily System Report - $(date)" > daily-report.md
          echo "" >> daily-report.md
          
          echo "### 📊 Repository Stats" >> daily-report.md
          echo "- **Total Files:** $(find . -type f | wc -l)" >> daily-report.md
          echo "- **Lines of Code:** $(find . -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1)" >> daily-report.md
          echo "- **Last Commit:** $(git log -1 --pretty=format:'%h - %s (%an)')" >> daily-report.md
          echo "" >> daily-report.md
          
          echo "### 🎨 Mockup Status" >> daily-report.md
          if [[ -d "admin-interface" ]]; then
            echo "- **Available Mockups:** $(ls admin-interface/*.html 2>/dev/null | wc -l)" >> daily-report.md
            echo "- **Total Size:** $(du -sh admin-interface/*.html 2>/dev/null | awk '{sum+=$1} END {print sum "K"}' || echo "0K")" >> daily-report.md
          fi
          echo "" >> daily-report.md
          
          echo "### 🔧 System Health" >> daily-report.md
          echo "- **Workflow Status:** ✅ Healthy" >> daily-report.md
          echo "- **GitHub Actions:** $(gh api repos/${{ github.repository }}/actions/runs --jq '.workflow_runs | length') recent runs" >> daily-report.md || echo "- **GitHub Actions:** N/A"
          echo "- **Last Update:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> daily-report.md
          
          cat daily-report.md

      - name: 📤 Upload Daily Report
        uses: actions/upload-artifact@v4
        with:
          name: daily-report-${{ github.run_number }}
          path: daily-report.md
          retention-days: 7

      - name: 💬 Post to Discussions (Optional)
        if: github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            // Optional: Post daily summary to GitHub Discussions
            const fs = require('fs');
            const report = fs.readFileSync('daily-report.md', 'utf8');
            
            // You can uncomment this to post to discussions
            // github.rest.teams.addOrUpdateDiscussionInOrg({
            //   discussion_number: 1, // Your discussion number
            //   title: `Daily Report - ${new Date().toDateString()}`,
            //   body: report
            // });
            
            console.log('Daily report generated successfully');

  backup-patrick-instructions:
    name: Backup Patrick Instructions
    runs-on: ubuntu-latest
    needs: daily-notion-report
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔒 Backup Critical Files
        run: |
          # Create backup of Patrick Instructions
          mkdir -p .github/backups
          
          # Backup with timestamp
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          cp -r .patrick .github/backups/patrick_backup_$TIMESTAMP
          
          # Keep only last 5 backups
          cd .github/backups
          ls -t patrick_backup_* | tail -n +6 | xargs rm -rf || true
          
          echo "✅ Patrick Instructions backed up successfully"
          ls -la .github/backups/

      - name: 📊 Verify Critical Files
        run: |
          echo "🔍 Verifying critical files exist:"
          
          CRITICAL_FILES=(
            ".patrick/README.md"
            ".patrick/notion-integration.py" 
            "admin-interface/mockup-automation.sh"
            "admin-interface/mockups-index.html"
            ".github/workflows/auto-mockups.yml"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              echo "✅ $file - OK"
            else
              echo "❌ $file - MISSING"
              exit 1
            fi
          done
          
          echo "🎉 All critical files verified!"

      - name: 📤 Commit Backups
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .github/backups/
          git diff --staged --quiet || git commit -m "🔒 Automated backup of Patrick Instructions - $(date +"%Y-%m-%d")"
          git push || echo "No changes to push" 