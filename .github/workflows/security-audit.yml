name: Enhanced Security Audit

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'requirements/**'
      - 'requirements.txt'
      - '.github/workflows/security-audit.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-audit:
    name: Comprehensive Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install security tools
        run: |
          pip install --upgrade pip
          pip install safety pip-audit bandit semgrep
          
      - name: Install project dependencies
        run: |
          pip install -r requirements.txt || true
          
      - name: Run security audit script
        run: |
          ./scripts/security_audit.sh
          
      - name: Run Semgrep security scan
        run: |
          semgrep --config=auto --json --output=security_reports/semgrep_$(date +%Y%m%d).json . || true
          
      - name: Check for high-severity vulnerabilities
        id: check_vulnerabilities
        run: |
          # Check if there are any critical or high severity issues
          CRITICAL_ISSUES=0
          
          # Check pip-audit results
          if [ -f security_reports/pip_audit_*.json ]; then
            CRITICAL_COUNT=$(jq '[.vulnerabilities[] | select(.aliases[] | contains("CVE")) | select(.fix_versions | length == 0)] | length' security_reports/pip_audit_*.json 2>/dev/null || echo "0")
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + CRITICAL_COUNT))
          fi
          
          echo "critical_issues=$CRITICAL_ISSUES" >> $GITHUB_OUTPUT
          
          if [ $CRITICAL_ISSUES -gt 0 ]; then
            echo "⚠️ Found $CRITICAL_ISSUES critical security issues!"
            exit 1
          else
            echo "✅ No critical security issues found"
          fi
          
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports-${{ github.run_number }}
          path: security_reports/
          retention-days: 30
          
      - name: Create issue for critical vulnerabilities
        if: failure() && steps.check_vulnerabilities.outputs.critical_issues > 0
        uses: actions/github-script@v6
        with:
          script: |
            const title = `🚨 Critical Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Critical Security Alert
            
            Our automated security audit has detected **${{ steps.check_vulnerabilities.outputs.critical_issues }}** critical security vulnerabilities.
            
            ### Immediate Action Required
            1. Review the security reports in the workflow artifacts
            2. Update vulnerable packages immediately
            3. Test the application after updates
            4. Close this issue once all vulnerabilities are resolved
            
            ### Reports Available
            - pip-audit results
            - safety check results  
            - bandit code scan results
            - semgrep security scan results
            
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            *This issue was automatically created by the security audit workflow.*
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'critical', 'automated']
            });
            
      - name: Comment on PR if security issues found
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `
            ## 🚨 Security Issues Detected
            
            This PR introduces or contains security vulnerabilities:
            - **${{ steps.check_vulnerabilities.outputs.critical_issues }}** critical issues found
            
            Please review the security reports and fix all issues before merging.
            
            **Security Reports:** Available in workflow artifacts
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

