#!/usr/bin/env node
/**
 * üõ†Ô∏è Cursor AI Zapier MCP CLI Tool
 * Command-line interface for managing Zapier integrations
 * 
 * @version 1.0.0
 * @author Orchestra AI System
 */

const { Command } = require('commander');
const fs = require('fs').promises;
const path = require('path');
const { spawn, exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);
const program = new Command();

program
  .name('zapier-mcp')
  .description('Cursor AI Zapier MCP Server CLI')
  .version('1.0.0');

// üöÄ Start server command
program
  .command('start')
  .description('Start the Zapier MCP server')
  .option('-p, --port <port>', 'Server port', '8001')
  .option('-e, --env <environment>', 'Environment', 'production')
  .option('-d, --daemon', 'Run as daemon')
  .action(async (options) => {
    console.log('üöÄ Starting Cursor AI Zapier MCP Server...');
    
    try {
      // Load environment variables
      await loadEnvironment();
      
      const port = options.port || process.env.MCP_SERVER_PORT || 8001;
      const env = options.env || process.env.NODE_ENV || 'production';
      
      console.log(`üìã Configuration:`);
      console.log(`   Port: ${port}`);
      console.log(`   Environment: ${env}`);
      
      if (options.daemon) {
        console.log('üîÑ Starting as daemon...');
        const child = spawn('node', ['server.js'], {
          detached: true,
          stdio: 'ignore',
          env: { ...process.env, MCP_SERVER_PORT: port, NODE_ENV: env }
        });
        child.unref();
        console.log(`‚úÖ Server started as daemon with PID: ${child.pid}`);
      } else {
        console.log('üîÑ Starting server...');
        const child = spawn('node', ['server.js'], {
          stdio: 'inherit',
          env: { ...process.env, MCP_SERVER_PORT: port, NODE_ENV: env }
        });
        
        process.on('SIGINT', () => {
          console.log('\nüõë Shutting down server...');
          child.kill('SIGTERM');
          process.exit(0);
        });
      }
    } catch (error) {
      console.error('‚ùå Failed to start server:', error.message);
      process.exit(1);
    }
  });

// üõë Stop server command
program
  .command('stop')
  .description('Stop the Zapier MCP server')
  .action(async () => {
    console.log('üõë Stopping Zapier MCP server...');
    
    try {
      const { stdout } = await execAsync("ps aux | grep 'node.*server.js' | grep -v grep | awk '{print $2}'");
      const pids = stdout.trim().split('\n').filter(pid => pid);
      
      if (pids.length === 0) {
        console.log('‚ÑπÔ∏è  No running server found.');
        return;
      }
      
      for (const pid of pids) {
        await execAsync(`kill ${pid}`);
        console.log(`‚úÖ Stopped server with PID: ${pid}`);
      }
    } catch (error) {
      console.error('‚ùå Failed to stop server:', error.message);
      process.exit(1);
    }
  });

// üè• Health check command
program
  .command('health')
  .description('Check server health')
  .option('-p, --port <port>', 'Server port', '8001')
  .action(async (options) => {
    const port = options.port || process.env.MCP_SERVER_PORT || 8001;
    const healthUrl = `http://localhost:${port}/health`;
    
    console.log(`üè• Checking server health at ${healthUrl}...`);
    
    try {
      const response = await fetch(healthUrl);
      const data = await response.json();
      
      if (response.ok) {
        console.log('‚úÖ Server is healthy!');
        console.log(`üìä Status: ${data.status}`);
        console.log(`‚è±Ô∏è  Uptime: ${Math.floor(data.uptime)}s`);
        console.log(`üîß Version: ${data.version}`);
      } else {
        console.log('‚ùå Server is unhealthy!');
        console.log(`üìä Status: ${response.status}`);
      }
    } catch (error) {
      console.log('‚ùå Server is not responding!');
      console.log(`üîç Error: ${error.message}`);
      process.exit(1);
    }
  });

// üîê Test authentication command
program
  .command('test-auth')
  .description('Test Zapier authentication')
  .option('-k, --api-key <key>', 'API key to test')
  .option('-p, --port <port>', 'Server port', '8001')
  .action(async (options) => {
    const port = options.port || process.env.MCP_SERVER_PORT || 8001;
    const apiKey = options.apiKey || process.env.ZAPIER_API_KEY;
    
    if (!apiKey) {
      console.error('‚ùå No API key provided. Use --api-key or set ZAPIER_API_KEY environment variable.');
      process.exit(1);
    }
    
    const authUrl = `http://localhost:${port}/api/v1/auth/verify`;
    
    console.log('üîê Testing authentication...');
    console.log(`üìã URL: ${authUrl}`);
    console.log(`üîë API Key: ${apiKey.substring(0, 10)}...`);
    
    try {
      const response = await fetch(authUrl, {
        headers: {
          'X-Zapier-API-Key': apiKey,
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (response.ok) {
        console.log('‚úÖ Authentication successful!');
        console.log(`üìã Workspace ID: ${data.workspace_id}`);
        console.log(`üîß Permissions: ${data.permissions.join(', ')}`);
      } else {
        console.log('‚ùå Authentication failed!');
        console.log(`üìä Status: ${response.status}`);
        console.log(`üí¨ Message: ${data.message}`);
      }
    } catch (error) {
      console.error('‚ùå Authentication test failed:', error.message);
      process.exit(1);
    }
  });

// üìã Setup command
program
  .command('setup')
  .description('Setup Zapier MCP server')
  .action(async () => {
    console.log('üîß Setting up Cursor AI Zapier MCP server...');
    
    try {
      // Create directories
      const dirs = ['logs', 'tests', 'config'];
      for (const dir of dirs) {
        await fs.mkdir(dir, { recursive: true });
        console.log(`üìÅ Created directory: ${dir}`);
      }
      
      // Copy environment template if .env doesn't exist
      const envExists = await fs.access('.env').then(() => true).catch(() => false);
      if (!envExists) {
        try {
          await fs.copyFile('environment.config', '.env');
          console.log('üìã Created .env from template');
        } catch (error) {
          console.log('‚ö†Ô∏è  Could not create .env file. Please copy from environment.config');
        }
      }
      
      // Install dependencies
      console.log('üì¶ Installing dependencies...');
      await execAsync('npm install');
      console.log('‚úÖ Dependencies installed');
      
      console.log('\nüéâ Setup complete!');
      console.log('\nüìã Next steps:');
      console.log('   1. Configure your .env file');
      console.log('   2. Run: zapier-mcp start');
      console.log('   3. Test: zapier-mcp health');
      
    } catch (error) {
      console.error('‚ùå Setup failed:', error.message);
      process.exit(1);
    }
  });

// üìä Status command
program
  .command('status')
  .description('Show server status and logs')
  .option('-f, --follow', 'Follow logs')
  .action(async (options) => {
    console.log('üìä Zapier MCP Server Status');
    console.log('===========================');
    
    try {
      // Check if server is running
      const { stdout } = await execAsync("ps aux | grep 'node.*server.js' | grep -v grep");
      const processes = stdout.trim().split('\n').filter(line => line);
      
      if (processes.length > 0) {
        console.log('‚úÖ Server is running');
        processes.forEach((process, index) => {
          const parts = process.split(/\s+/);
          console.log(`   Process ${index + 1}: PID ${parts[1]}, CPU ${parts[2]}%, Memory ${parts[3]}%`);
        });
      } else {
        console.log('‚ùå Server is not running');
      }
      
      // Show recent logs
      console.log('\nüìù Recent logs:');
      try {
        const logFile = './logs/zapier-mcp.log';
        const logExists = await fs.access(logFile).then(() => true).catch(() => false);
        
        if (logExists) {
          if (options.follow) {
            console.log('üì∫ Following logs (Ctrl+C to stop)...');
            const tail = spawn('tail', ['-f', logFile], { stdio: 'inherit' });
            
            process.on('SIGINT', () => {
              tail.kill('SIGTERM');
              process.exit(0);
            });
          } else {
            const { stdout: logs } = await execAsync(`tail -n 20 ${logFile}`);
            console.log(logs);
          }
        } else {
          console.log('   No log file found');
        }
      } catch (error) {
        console.log('   Could not read logs:', error.message);
      }
      
    } catch (error) {
      console.error('‚ùå Failed to get status:', error.message);
      process.exit(1);
    }
  });

// üß™ Test triggers command
program
  .command('test-trigger')
  .description('Test Zapier trigger')
  .option('-t, --type <type>', 'Trigger type (code-updated, deployment-complete, error-detected)', null, true)
  .option('-p, --port <port>', 'Server port', '8001')
  .option('-k, --api-key <key>', 'API key')
  .action(async (options) => {
    if (!options.type) {
      console.error('‚ùå Type is required. Use --type or -t with one of: code-updated, deployment-complete, error-detected');
      process.exit(1);
    }
    const port = options.port || process.env.MCP_SERVER_PORT || 8001;
    const apiKey = options.apiKey || process.env.ZAPIER_API_KEY;
    
    if (!apiKey) {
      console.error('‚ùå No API key provided.');
      process.exit(1);
    }
    
    const triggerUrl = `http://localhost:${port}/api/v1/triggers/${options.type}`;
    
    // Test data for different trigger types
    const testData = {
      'code-updated': {
        file_path: '/test/example.js',
        project_path: process.cwd()
      },
      'deployment-complete': {
        deployment_url: 'https://test-deployment.vercel.app',
        environment: 'test',
        status: 'success'
      },
      'error-detected': {
        error_type: 'SyntaxError',
        error_message: 'Unexpected token',
        file_path: '/test/error.js',
        line_number: 42
      }
    };
    
    console.log(`üß™ Testing trigger: ${options.type}`);
    console.log(`üìã URL: ${triggerUrl}`);
    
    try {
      const response = await fetch(triggerUrl, {
        method: 'POST',
        headers: {
          'X-Zapier-API-Key': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(testData[options.type])
      });
      
      const data = await response.json();
      
      if (response.ok) {
        console.log('‚úÖ Trigger test successful!');
        console.log('üìä Response:');
        console.log(JSON.stringify(data, null, 2));
      } else {
        console.log('‚ùå Trigger test failed!');
        console.log(`üìä Status: ${response.status}`);
        console.log('üí¨ Response:', JSON.stringify(data, null, 2));
      }
    } catch (error) {
      console.error('‚ùå Trigger test failed:', error.message);
      process.exit(1);
    }
  });

// üõ†Ô∏è Utility functions
async function loadEnvironment() {
  try {
    const envFile = await fs.readFile('.env', 'utf8');
    const lines = envFile.split('\n');
    
    for (const line of lines) {
      const trimmed = line.trim();
      if (trimmed && !trimmed.startsWith('#')) {
        const [key, ...valueParts] = trimmed.split('=');
        const value = valueParts.join('=');
        if (key && value) {
          process.env[key] = value;
        }
      }
    }
  } catch (error) {
    // .env file doesn't exist or can't be read
    console.log('‚ö†Ô∏è  No .env file found. Using environment variables.');
  }
}

// üìã Info command
program
  .command('info')
  .description('Show integration information for Zapier Developer Platform')
  .action(() => {
    console.log('üìã Cursor AI Development Assistant - Zapier Integration Info');
    console.log('============================================================');
    console.log('');
    console.log('üîß Integration Details:');
    console.log('   Name: Cursor AI Development Assistant');
    console.log('   Description: Autonomous AI agent for code development and workflow automation');
    console.log('   Category: Developer Tools');
    console.log('   Authentication: API Key');
    console.log('');
    console.log('üåê Server Details:');
    console.log(`   Base URL: http://localhost:${process.env.MCP_SERVER_PORT || 8001}`);
    console.log('   API Version: v1');
    console.log('');
    console.log('üîê Authentication Fields:');
    console.log('   api_key (required): Your Cursor AI API key');
    console.log('   workspace_id (optional): Your workspace identifier');
    console.log('');
    console.log('üéØ Available Triggers:');
    console.log('   ‚Ä¢ Code Updated: Triggers when code changes are detected');
    console.log('   ‚Ä¢ Deployment Complete: Triggers when deployment finishes');
    console.log('   ‚Ä¢ Error Detected: Triggers when errors are found in code');
    console.log('');
    console.log('üöÄ Available Actions:');
    console.log('   ‚Ä¢ Generate Code: Generate code based on prompts');
    console.log('   ‚Ä¢ Deploy Project: Deploy project to various platforms');
    console.log('   ‚Ä¢ Run Tests: Execute test suites');
    console.log('   ‚Ä¢ Analyze Project: Analyze project structure and dependencies');
    console.log('');
    console.log('üìö API Documentation: http://localhost:8001/api/v1/docs');
  });

program.parse(process.argv); 