server {
    listen 80;
    server_name cherry-ai.me www.cherry-ai.me;
    root /var/www/orchestra-admin;

    index index.html;

    # Force no caching for index.html - SPA entry point
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Serve static Admin UI files
    location / {
        try_files $uri $uri/ /index.html; # Standard for SPAs
        
        # No cache for HTML files generally (though index.html rule above is more specific)
        location ~* \.html$ {
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        }
        
        # Cache assets with unique hashes (like main.asdf123.js) for 1 year
        location ~* \.(?:css|js|woff2?|eot|ttf|otf|svg|png|jpg|jpeg|gif|ico|webp)$ {
            if ($uri ~* "\.[a-f0-9]{8,}\.(css|js|woff2?|eot|ttf|otf|svg|png|jpg|jpeg|gif|ico|webp)$") { # Check for hash in filename
                 add_header Cache-Control "public, max-age=31536000, immutable";
            }
        }
    }

    # API proxy (backend application)
    location /api/ {
        proxy_pass http://localhost:8000/; # Assuming backend runs on port 8000
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Weaviate proxy
    location /weaviate/ {
        proxy_pass http://localhost:8080/; # Assuming Weaviate runs on port 8080
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Optional: Add other specific backend proxies if needed (e.g., /docs, /health)
    location /docs {
        proxy_pass http://localhost:8000/docs;
        proxy_set_header Host $host;
    }
    location /health {
        proxy_pass http://localhost:8000/health;
        proxy_set_header Host $host;
    }

    # Security Headers (can be expanded)
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always; # Example CSP
} 